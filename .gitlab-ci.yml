# Gitlab CI/CD for guardata

.shared_windows_runners:
  tags:
  - shared-windows
  - windows
  - windows-1809

windows-tests:
  extends:
    - .shared_windows_runners
  stage: test
  except:
    - tags
  before_script:
    - Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1"
    - choco install -y python --version=3.7.8
    - choco install -y winfsp --version=1.7.20172
    - mkdir winfsp-test
    - curl -o winfsp-tests-1.7.20172.zip https://github.com/billziss-gh/winfsp/releases/download/v1.7/winfsp-tests-1.7.20172.zip
    - Expand-Archive winfsp-tests-1.7.20172.zip -DestinationPath winfsp-test
    - RefreshEnv
    - python.exe -m pip install -r pre-requirements.txt
    - $env:PATH+=";$env:CI_PROJECT_DIR\winfsp-test"
      # build wheel
    - python.exe setup.py bdist_wheel
    - rm -R -Force guardata
      # Install the guardata wheel with all dependencies
    - $WHLfiles = Get-ChildItem "dist\guardata-*.whl" | ForEach-Object {$_.Name}
    - python.exe -m pip install "dist\$WHLfiles[all]"
      # Check dependency compatibility
    - python.exe -m pip check guardata[all]
      # Check winfsp-tests availability
    - python.exe -c "import winfspy.tests.winfsp_tests"
  script:
    - $env:QT_QPA_PLATFORM="offscreen"
    # py.test --log-level=DEBUG --durations=10 -v tests -n auto --max-worker-restart=0 -x
    # py.test --log-level=DEBUG --durations=10 -v tests --runmountpoint --runslow -m mountpoint -x
    - py.test --log-level=DEBUG --durations=10 -v tests --runmountpoint --runslow --rungui -m gui -x
    # py.test --log-level=DEBUG --durations=10 -v tests --runslow -m slow -n auto --max-worker-restart=0 -x
